<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wichtelbrief Generator - Konfigurierbare Anzahl</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Indie+Flower&family=Nanum+Pen+Script&family=Homemade+Apple&family=Shadows+Into+Light&family=Gloria+Hallelujah&family=Nothing+You+Could+Do&family=Permanent+Marker&family=Reenie+Beanie&family=Zeyada&display=swap" rel="stylesheet">
    <style>
        :root {
            --paper-color: #fffef0;
            --line-color: rgba(226, 232, 240, 0.7);
            --a4-width: 210mm;
            --a4-height: 297mm;
        }

        body {
            background-color: #e2e8f0;
            min-height: 100vh;
        }

        .a4-container {
            width: 100%;
            max-width: var(--a4-width);
            aspect-ratio: 210 / 297;
            margin: 0 auto;
            position: relative;
        }

        .paper-grid {
            background-color: #ccc;
            display: grid;
            gap: 1px;
            width: 100%;
            height: 100%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .mini-card {
            background-color: var(--paper-color);
            background-image: linear-gradient(var(--line-color) 1px, transparent 1px);
            padding: 8mm;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            hyphens: auto;
            -webkit-hyphens: auto;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .handwritten-char {
            display: inline-block;
            white-space: pre;
            transform-origin: bottom center;
        }

        .handwritten-word {
            display: inline-block;
            white-space: nowrap;
        }

        .font-homemade { font-family: 'Homemade Apple', cursive; }
        .font-caveat { font-family: 'Caveat', cursive; }
        .font-indie { font-family: 'Indie Flower', cursive; }
        .font-shadows { font-family: 'Shadows Into Light', cursive; }
        .font-gloria { font-family: 'Gloria Hallelujah', cursive; }
        .font-nothing { font-family: 'Nothing You Could Do', cursive; }
        .font-marker { font-family: 'Permanent Marker', cursive; }
        .font-reenie { font-family: 'Reenie Beanie', cursive; }
        .font-zeyada { font-family: 'Zeyada', cursive; }

        @media print {
            @page { size: A4; margin: 0; }
            body { background: white !important; padding: 0 !important; margin: 0 !important; }
            .no-print { display: none !important; }
            .a4-container { max-width: none !important; width: 210mm !important; height: 297mm !important; margin: 0 !important; }
            .paper-grid { box-shadow: none !important; gap: 0 !important; border: 0.1mm solid #eee; }
            .mini-card { border: 0.1mm solid #eee; }
        }

        .style-btn.active {
            border-color: #ef4444;
            background-color: #fef2f2;
            color: #b91c1c;
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        #inputGrid textarea {
            min-height: 60px;
            font-size: 11px;
            padding: 8px;
        }
    </style>
</head>
<body class="p-4 md:p-6 lg:p-8" lang="de">

    <div class="max-w-[1600px] mx-auto">
        <header class="mb-6 flex flex-wrap justify-between items-end gap-4 no-print">
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Wichtel-Datei-Zentrale ðŸŽ…ðŸ“‚</h1>
                <p class="text-slate-500 text-sm">Jetzt mit flexibler Anzahl an Briefen.</p>
            </div>
            <div class="flex flex-wrap gap-2">
                <button onclick="exportToFile()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-blue-700 transition-all flex items-center gap-2">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    Exportieren (.json)
                </button>
                <label class="bg-emerald-600 text-white px-4 py-2 rounded-xl font-bold hover:bg-emerald-700 transition-all flex items-center gap-2 cursor-pointer">
                    <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                    Importieren
                    <input type="file" id="importFile" class="hidden" accept=".json" onchange="importFromFile(event)">
                </label>
                <button onclick="window.print()" class="bg-red-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-red-700 shadow-lg shadow-red-200 flex items-center gap-2 transition-all active:scale-95">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M6 9V2h12v7M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2m-2 4H8v-4h8v4z"></path></svg>
                    Drucken
                </button>
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            <!-- Sidebar -->
            <div class="w-full lg:w-[450px] flex flex-col gap-4 no-print shrink-0">
                <!-- Count Selector -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs uppercase font-bold text-slate-400">Anzahl der Briefe</label>
                        <span id="countDisplay" class="bg-red-100 text-red-600 px-2 py-0.5 rounded-full text-xs font-bold">6</span>
                    </div>
                    <input type="range" id="letterCountRange" min="1" max="12" value="6" class="w-full h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer accent-red-500">
                    <p class="text-[10px] text-slate-400 mt-2 italic">Hinweis: Das Layout (Spalten/Zeilen) passt sich automatisch an.</p>
                </div>

                <!-- Multi-Editor Box -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between items-center mb-4">
                        <label class="text-xs uppercase font-bold text-slate-400">Botschaften</label>
                        <input type="text" id="saveName" placeholder="Name des Sets" class="text-xs border-b border-slate-200 focus:border-red-500 outline-none pb-1 w-32">
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3 max-h-[400px] overflow-y-auto pr-2 custom-scroll" id="inputGrid">
                        <!-- Wird dynamisch gefÃ¼llt -->
                    </div>
                </div>

                <!-- Settings Box -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                    <div>
                        <span class="text-xs uppercase font-bold text-slate-400 block mb-2">Handschrift</span>
                        <div class="grid grid-cols-2 gap-2" id="fontGrid">
                            <button onclick="selectFont(this, 'font-homemade')" class="style-btn p-2 border border-slate-100 rounded-lg text-[10px] font-homemade transition-all hover:border-red-200">Apple</button>
                            <button onclick="selectFont(this, 'font-caveat')" class="style-btn p-2 border border-slate-100 rounded-lg text-[10px] font-caveat transition-all hover:border-red-200">Caveat</button>
                            <button onclick="selectFont(this, 'font-nothing')" class="style-btn p-2 border border-slate-100 rounded-lg text-[10px] font-nothing transition-all hover:border-red-200">Natural</button>
                            <button onclick="selectFont(this, 'font-zeyada')" class="style-btn p-2 border border-slate-100 rounded-lg text-[10px] font-zeyada transition-all hover:border-red-200">Elegant</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs uppercase font-bold text-slate-400 block">GrÃ¶ÃŸe</label>
                            <input type="range" id="sizeRange" min="8" max="25" value="16" class="w-full h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer mt-3 accent-red-500">
                        </div>
                        <div>
                            <label class="text-xs uppercase font-bold text-slate-400 block">Jitter</label>
                            <input type="range" id="jitterRange" min="0" max="20" value="8" class="w-full h-1.5 bg-slate-100 rounded-lg appearance-none cursor-pointer mt-3 accent-red-500">
                        </div>
                    </div>

                    <div class="flex items-center justify-between">
                        <input type="color" id="colorPicker" value="#1e293b" class="w-8 h-8 rounded-full cursor-pointer border-2 border-slate-100 p-0 overflow-hidden">
                        <button onclick="regenerate()" class="text-xs font-bold text-slate-500 bg-slate-50 px-3 py-2 rounded-lg hover:bg-slate-100">Neu mischen</button>
                    </div>
                </div>

                <!-- Local Storage -->
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200 flex-grow">
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-xs uppercase font-bold text-slate-400 block">Lokale Schnell-Speicherung</span>
                        <button onclick="saveToBrowser()" class="text-[10px] bg-slate-100 px-2 py-1 rounded hover:bg-slate-200 transition-all font-bold">Set merken</button>
                    </div>
                    <div id="savedList" class="space-y-2 max-h-40 overflow-y-auto custom-scroll">
                        <p class="text-xs text-slate-300 italic text-center py-4">Keine gemerkten Sets.</p>
                    </div>
                </div>
            </div>

            <!-- Preview -->
            <div class="flex-grow flex items-start justify-center overflow-auto p-4 bg-slate-300/30 rounded-3xl border border-slate-300/50 min-h-[800px]">
                <div class="a4-container">
                    <div id="paperGrid" class="paper-grid font-homemade" style="color: #1e293b; font-size: 16px;">
                        <!-- Wird dynamisch gefÃ¼llt -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <svg style="position: absolute; width: 0; height: 0;"><defs id="filter-bank"></defs></svg>

    <script>
        const inputGrid = document.getElementById('inputGrid');
        const letterCountRange = document.getElementById('letterCountRange');
        const countDisplay = document.getElementById('countDisplay');
        const sizeRange = document.getElementById('sizeRange');
        const jitterRange = document.getElementById('jitterRange');
        const colorPicker = document.getElementById('colorPicker');
        const paperGrid = document.getElementById('paperGrid');
        const filterBank = document.getElementById('filter-bank');
        const savedList = document.getElementById('savedList');
        const saveNameInput = document.getElementById('saveName');
        const FILTER_COUNT = 30;
        let currentFont = 'font-homemade';
        let letterData = ["Lieber Wichtelfreund, heute ist ein ganz besonders schÃ¶ner Tag.", "Brief 2", "Brief 3", "Brief 4", "Brief 5", "Brief 6", "Brief 7", "Brief 8", "Brief 9", "Brief 10", "Brief 11", "Brief 12"];

        function initUI() {
            const count = parseInt(letterCountRange.value);
            countDisplay.textContent = count;
            
            // Layout Kalkulation
            let cols = 3;
            if (count <= 2) cols = 1;
            else if (count <= 4) cols = 2;
            else if (count <= 12) cols = 3;
            
            paperGrid.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
            
            // Inputs generieren
            inputGrid.innerHTML = '';
            paperGrid.innerHTML = '';
            
            for (let i = 0; i < count; i++) {
                // Textarea
                const area = document.createElement('textarea');
                area.dataset.index = i;
                area.className = "w-full p-2 border border-slate-100 bg-slate-50 rounded-lg outline-none focus:ring-1 focus:ring-red-400 leading-tight";
                area.value = letterData[i] || `Brief ${i+1}`;
                area.placeholder = `Text fÃ¼r Brief ${i+1}...`;
                area.addEventListener('input', (e) => {
                    letterData[i] = e.target.value;
                    updateHandwriting(i);
                });
                inputGrid.appendChild(area);

                // Card
                const card = document.createElement('div');
                card.className = "mini-card";
                card.dataset.index = i;
                const content = document.createElement('div');
                content.className = "output-content";
                content.setAttribute("lang", "de");
                card.appendChild(content);
                paperGrid.appendChild(card);
            }
            
            updatePaperStyle();
            updateHandwriting();
        }

        function createFilters() {
            filterBank.innerHTML = '';
            for(let i = 0; i < FILTER_COUNT; i++) {
                const filter = document.createElementNS("http://www.w3.org/2000/svg", "filter");
                filter.setAttribute("id", `jitter-${i}`);
                const turb = document.createElementNS("http://www.w3.org/2000/svg", "feTurbulence");
                turb.setAttribute("type", "fractalNoise");
                turb.setAttribute("baseFrequency", (0.015 + Math.random() * 0.04).toFixed(3));
                turb.setAttribute("numOctaves", "2");
                turb.setAttribute("seed", Math.floor(Math.random() * 3000));
                const disp = document.createElementNS("http://www.w3.org/2000/svg", "feDisplacementMap");
                disp.setAttribute("in", "SourceGraphic");
                disp.setAttribute("scale", (jitterRange.value / 4).toFixed(1));
                disp.setAttribute("xChannelSelector", "R");
                disp.setAttribute("yChannelSelector", "G");
                filter.appendChild(turb);
                filter.appendChild(disp);
                filterBank.appendChild(filter);
            }
        }

        function createJitteredSpan(char, jitterScale) {
            const span = document.createElement('span');
            span.textContent = char;
            span.className = 'handwritten-char';
            const filterId = Math.floor(Math.random() * FILTER_COUNT);
            span.style.filter = `url(#jitter-${filterId})`;
            const rotation = (Math.random() - 0.5) * (3.2 * jitterScale); 
            const yShift = (Math.random() - 0.5) * (4.2 * jitterScale);
            const xShift = (Math.random() - 0.5) * (1.5 * jitterScale);
            const xScale = 1 + (Math.random() - 0.5) * (0.12 * jitterScale);
            const yScale = 1 + (Math.random() - 0.5) * (0.12 * jitterScale);
            span.style.transform = `rotate(${rotation.toFixed(2)}deg) translate(${xShift.toFixed(1)}px, ${yShift.toFixed(1)}px) scale(${xScale.toFixed(2)}, ${yScale.toFixed(2)})`;
            span.style.opacity = 0.85 + Math.random() * 0.15;
            return span;
        }

        function updateHandwriting(index = null) {
            const jitterScale = jitterRange.value / 10;
            const cardOutputs = document.querySelectorAll('.mini-card .output-content');
            const count = parseInt(letterCountRange.value);
            const indices = index !== null ? [index] : Array.from({length: count}, (_, i) => i);
            
            indices.forEach(idx => {
                if (!cardOutputs[idx]) return;
                const text = letterData[idx] || "";
                const container = cardOutputs[idx];
                container.innerHTML = '';
                
                const words = text.split(/(\s+)/); 
                words.forEach(word => {
                    if (word === '\n' || word.includes('\n')) {
                        const lines = word.split('\n');
                        lines.forEach((l, i) => {
                            if (i > 0) container.appendChild(document.createElement('br'));
                            processWord(l, container, jitterScale);
                        });
                        return;
                    }
                    processWord(word, container, jitterScale);
                });
            });
        }

        function processWord(word, container, jitterScale) {
            if (!word) return;
            if (/^\s+$/.test(word)) {
                word.split('').forEach(char => container.appendChild(createJitteredSpan(char, jitterScale)));
                return;
            }
            const wordSpan = document.createElement('span');
            wordSpan.className = 'handwritten-word';
            word.split('').forEach(char => {
                wordSpan.appendChild(createJitteredSpan(char, jitterScale));
            });
            container.appendChild(wordSpan);
        }

        function selectFont(btn, fontClass) {
            document.querySelectorAll('.style-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');
            else {
                const target = Array.from(document.querySelectorAll('.style-btn')).find(b => b.classList.contains(fontClass));
                if(target) target.classList.add('active');
            }
            const fontClasses = ['font-homemade', 'font-caveat', 'font-indie', 'font-shadows', 'font-gloria', 'font-nothing', 'font-marker', 'font-reenie', 'font-zeyada'];
            paperGrid.classList.remove(...fontClasses);
            paperGrid.classList.add(fontClass);
            currentFont = fontClass;
        }

        function updatePaperStyle() {
            const val = sizeRange.value;
            const cards = document.querySelectorAll('.mini-card');
            const lineHeight = val * 1.5;
            paperGrid.style.fontSize = val + 'px';
            cards.forEach(card => {
                card.style.lineHeight = lineHeight + 'px';
                card.style.backgroundSize = `100% ${lineHeight}px`;
            });
        }

        function exportToFile() {
            const name = saveNameInput.value.trim() || `Wichtelbrief_Set_${new Date().toISOString().slice(0,10)}`;
            const briefData = {
                version: "1.1",
                name: name,
                texts: letterData.slice(0, parseInt(letterCountRange.value)),
                font: currentFont,
                size: sizeRange.value,
                jitter: jitterRange.value,
                color: colorPicker.value,
                count: letterCountRange.value
            };
            const blob = new Blob([JSON.stringify(briefData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if(data.count) letterCountRange.value = data.count;
                    letterData = data.texts;
                    loadBrief(data);
                    saveNameInput.value = data.name || "";
                    alert("Brief-Set erfolgreich geladen!");
                } catch (err) {
                    alert("Fehler beim Lesen der Datei.");
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function saveToBrowser() {
            const name = saveNameInput.value.trim() || `Lokales Set ${new Date().toLocaleTimeString()}`;
            const data = {
                id: Date.now(),
                name: name,
                texts: letterData.slice(0, parseInt(letterCountRange.value)),
                font: currentFont,
                size: sizeRange.value,
                jitter: jitterRange.value,
                color: colorPicker.value,
                count: letterCountRange.value
            };
            let saved = JSON.parse(localStorage.getItem('wichtel_sets_v2') || '[]');
            saved.unshift(data);
            localStorage.setItem('wichtel_sets_v2', JSON.stringify(saved));
            renderSavedList();
        }

        function loadBrief(brief) {
            letterCountRange.value = brief.count || 6;
            letterData = brief.texts;
            sizeRange.value = brief.size;
            jitterRange.value = brief.jitter;
            colorPicker.value = brief.color;
            selectFont(null, brief.font);
            paperGrid.style.color = brief.color;
            initUI();
        }

        function renderSavedList() {
            const saved = JSON.parse(localStorage.getItem('wichtel_sets_v2') || '[]');
            if (saved.length === 0) {
                savedList.innerHTML = '<p class="text-xs text-slate-300 italic text-center py-4">Keine gemerkten Sets.</p>';
                return;
            }
            savedList.innerHTML = saved.map(brief => `
                <div class="group flex items-center justify-between p-2 hover:bg-slate-50 rounded-lg cursor-pointer border border-transparent hover:border-slate-100 transition-all" onclick='loadFromList(${brief.id})'>
                    <div class="flex flex-col">
                        <span class="text-xs font-bold text-slate-700 truncate w-32">${brief.name}</span>
                        <span class="text-[9px] text-slate-400">${brief.count || 6} Briefe</span>
                    </div>
                    <button onclick="deleteFromList(${brief.id}, event)" class="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                        <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `).join('');
        }

        window.loadFromList = function(id) {
            const saved = JSON.parse(localStorage.getItem('wichtel_sets_v2') || '[]');
            const brief = saved.find(b => b.id === id);
            if(brief) loadBrief(brief);
        };

        window.deleteFromList = function(id, e) {
            e.stopPropagation();
            let saved = JSON.parse(localStorage.getItem('wichtel_sets_v2') || '[]');
            saved = saved.filter(b => b.id !== id);
            localStorage.setItem('wichtel_sets_v2', JSON.stringify(saved));
            renderSavedList();
        };

        letterCountRange.addEventListener('input', initUI);
        sizeRange.addEventListener('input', updatePaperStyle);
        jitterRange.addEventListener('input', () => {
            Array.from(filterBank.querySelectorAll('feDisplacementMap')).forEach(disp => {
                disp.setAttribute('scale', (jitterRange.value / 4).toFixed(1));
            });
            updateHandwriting();
        });
        colorPicker.addEventListener('input', (e) => { paperGrid.style.color = e.target.value; });
        function regenerate() { createFilters(); updateHandwriting(); }

        createFilters();
        initUI();
        renderSavedList();
        document.querySelector('.style-btn').classList.add('active');
    </script>
</body>
</html>

